<!DOCTYPE html>
<html lang="{{.Lang}}">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>{{index .I18n "Title"}}</title>
    <style>
        :root {
            --bg: #f7f8fa;
            --card: #ffffff;
            --accent: #007bff;
            --muted: #6b7280
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            font-family: "roboto", "Microsoft YaHei", Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: #0f172a;
            padding: 18px
        }

        .wrap {
            max-width: 720px;
            margin: 0 auto
        }

        .card {
            background: var(--card);
            padding: 14px;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(2, 6, 23, 0.06)
        }

        h2 {
            font-size: 18px;
            margin: 0 0 12px
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 12px
        }

        .file-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 16px 0;
        }

        .fileBtn {
            display: inline-block;
            padding: 12px 14px;
            background: var(--accent);
            color: #fff;
            border-radius: 10px;
            font-weight: 600
        }

        input[type=file] {
            flex: 1
        }

        .filename {
            font-size: 13px;
            color: var(--muted);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap
        }

        #fileList {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px
        }

        .file-item {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            background: #f8fafc;
            padding: 8px 10px;
            border-radius: 8px;
            font-size: 13px
        }

        .file-top {
            display: flex;
            align-items: center;
            gap: 8px
        }

        .file-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 8px
        }

        .file-size {
            color: var(--muted);
            font-size: 12px;
            margin-left: 8px
        }

        .file-remove-btn {
            background: #ef4444;
            color: #fff;
            padding: 6px 8px;
            border-radius: 8px;
            border: 0;
            font-size: 12px;
            cursor: pointer;
            margin-left: 8px
        }

        .progress-container {
            width: 100%;
            height: 8px;
            background: #e6eef8;
            border-radius: 8px;
            margin-top: 8px;
            overflow: hidden
        }

        .progress-bar {
            height: 100%;
            background: #0366d6;
            width: 0%;
            transition: width .2s linear
        }

        button {
            appearance: none;
            border: 0;
            background: var(--accent);
            color: white;
            padding: 12px;
            border-radius: 10px;
            font-size: 16px
        }

        .hint {
            font-size: 13px;
            color: var(--muted);
            margin-top: 8px
        }

        .cut-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: stretch;
        }

        #langSelect {
            width: 100%;
            box-sizing: border-box;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            background: #ffffff;
            font-size: 16px;
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
        }

        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0 0 0 0);
            white-space: nowrap;
            border: 0;
            left: -9999px;
        }

        .cut-col {
            flex: 1;
            min-width: 160px;
            margin-top: 10px;
        }

        .field-label {
            font-size: 13px;
            color: #374151;
            display: block;
            margin-bottom: 4px;
        }

        .input-box {
            width: calc(100% - 8px);
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            box-sizing: border-box;
            margin-right: 8px;
        }

        .mt-10 {
            margin-top: 10px;
        }

        .danger {
            background: #ef4444;
        }
    </style>
    <script>
        var MAX_UPLOAD_BYTES = parseInt('{{.MaxUpload}}', 10) || null;
        var MAX_UPLOAD_READABLE = '{{.MaxUploadReadable}}';
        var I18N = {
            SelectAtLeastOne: '{{index .I18n "SelectAtLeastOne"}}',
            FileTooLargePrefix: '{{index .I18n "FileTooLargePrefix"}}',
            FileTooLargeSuffix: '{{index .I18n "FileTooLargeSuffix"}}',
            FileTooLargeEnd: '{{index .I18n "FileTooLargeEnd"}}',
            UploadingText: '{{index .I18n "UploadingText"}}',
            UploadButton: '{{index .I18n "UploadButton"}}',
            Hint: '{{index .I18n "Hint"}}',
            Remove: '{{index .I18n "Remove"}}'
        };

        window.addEventListener('DOMContentLoaded', function () {
            var input = document.getElementById('videosInput');
            var listEl = document.getElementById('fileList');
            var btn = document.querySelector('button[type="submit"]');
            var selectedFiles = [];

            function updateInputFiles() {
                try {
                    var dt = new DataTransfer();
                    selectedFiles.forEach(function (f) { dt.items.add(f); });
                    input.files = dt.files;
                } catch (e) { }
            }

            function renderList() {
                listEl.innerHTML = '';
                selectedFiles.forEach(function (f, idx) {
                    var it = document.createElement('div'); it.className = 'file-item';
                    var top = document.createElement('div'); top.className = 'file-top';
                    var n = document.createElement('div'); n.className = 'file-name'; n.textContent = f.name;
                    var s = document.createElement('div'); s.className = 'file-size'; s.textContent = (f.size ? Math.round(f.size / 1024) + ' KB' : '');
                    var rem = document.createElement('button'); rem.className = 'file-remove-btn'; rem.textContent = I18N.Remove || '移除';
                    rem.addEventListener('click', function (e) {
                        e.preventDefault();
                        selectedFiles.splice(idx, 1);
                        updateInputFiles();
                        renderList();
                    });
                    top.appendChild(n); top.appendChild(s); top.appendChild(rem);
                    var progressWrap = document.createElement('div'); progressWrap.className = 'progress-container';
                    var progressBar = document.createElement('div'); progressBar.className = 'progress-bar';
                    progressBar.setAttribute('data-idx', idx);
                    progressWrap.appendChild(progressBar);
                    it.appendChild(top);
                    it.appendChild(progressWrap);
                    listEl.appendChild(it);
                });
            }

            input.addEventListener('change', function () {
                var files = Array.from(this.files || []);
                selectedFiles = selectedFiles.concat(files);
                updateInputFiles();
                renderList();
            });

            var uploadForm = document.querySelector('form[action="/upload"]');
            var isSubmitting = false;
            if (uploadForm) {
                uploadForm.addEventListener('submit', function (e) {
                    e.preventDefault();

                    var submitBtn = this.querySelector('button[type="submit"]');

                    if (isSubmitting) {
                        return;
                    }
                    if (!(selectedFiles && selectedFiles.length > 0)) {
                        alert(I18N.SelectAtLeastOne);
                        return;
                    }

                    for (var xi = 0; xi < selectedFiles.length; xi++) {
                        var sf = selectedFiles[xi];
                        if (typeof MAX_UPLOAD_BYTES === 'number' && (sf.size || 0) > MAX_UPLOAD_BYTES) {
                            alert(I18N.FileTooLargePrefix + sf.name + I18N.FileTooLargeSuffix + MAX_UPLOAD_READABLE + I18N.FileTooLargeEnd);
                            if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = I18N.UploadButton; submitBtn.removeAttribute('aria-busy'); }
                            isSubmitting = false;
                            return;
                        }
                    }
                    isSubmitting = true;
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.textContent = I18N.UploadingText;
                        submitBtn.setAttribute('aria-busy', 'true');
                    }

                    // 禁用所有的移除按钮, 防止在上传过程中修改文件列表
                    var removeBtns = Array.from(this.querySelectorAll('.file-remove-btn'));
                    removeBtns.forEach(function (b) { try { b.disabled = true; } catch (e) { } });

                    var formData = new FormData();
                    for (var i = 0; i < selectedFiles.length; i++) {
                        formData.append('videos', selectedFiles[i], selectedFiles[i].name);
                    }
                    var headInput = this.querySelector('input[name="head"]');
                    if (headInput) formData.append('head', headInput.value);
                    var tailInput = this.querySelector('input[name="tail"]');
                    if (tailInput) formData.append('tail', tailInput.value);

                    var xhr = new XMLHttpRequest();
                    var totalSizes = selectedFiles.reduce(function (acc, f) { return acc + (f.size || 0); }, 0);

                    xhr.upload.onprogress = function (ev) {
                        var loaded = ev.loaded;
                        var acc = 0;
                        for (var i = 0; i < selectedFiles.length; i++) {
                            var f = selectedFiles[i];
                            var prev = acc;
                            acc += f.size || 0;
                            var fileLoaded = Math.max(0, Math.min(f.size || 0, loaded - prev));
                            var pct = f.size ? Math.round((fileLoaded / f.size) * 100) : 0;
                            var bar = document.querySelector('.progress-bar[data-idx="' + i + '"]');
                            if (bar) bar.style.width = pct + '%';
                        }
                    };

                    xhr.onload = function () {
                        if (xhr.status >= 200 && xhr.status < 400) {
                            document.open();
                            document.write(xhr.responseText);
                            document.close();
                        } else {
                            var resp = xhr.responseText && xhr.responseText.trim() ? xhr.responseText : ('上传失败：' + xhr.statusText);
                            try {
                                if (resp.indexOf('<') === 0) {
                                    document.open();
                                    document.write(resp);
                                    document.close();
                                } else {
                                    alert(resp);
                                }
                            } catch (e) {
                                alert(resp);
                            }
                            if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = I18N.UploadButton; submitBtn.removeAttribute('aria-busy'); }
                            // 恢复移除按钮
                            removeBtns.forEach(function (b) { try { b.disabled = false; } catch (e) { } });
                            isSubmitting = false;
                        }
                    };

                    xhr.onerror = function () {
                        alert('上传出错');
                        if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = I18N.UploadButton; submitBtn.removeAttribute('aria-busy'); }
                        // 恢复移除按钮
                        removeBtns.forEach(function (b) { try { b.disabled = false; } catch (e) { } });
                        isSubmitting = false;
                    };

                    xhr.open('POST', uploadForm.action);
                    xhr.send(formData);
                });
            }

            var fileLabels = document.getElementsByClassName('fileBtn');
            if (fileLabels && fileLabels.length && input) {
                for (var i = 0; i < fileLabels.length; i++) {
                    (function (lbl) {
                        try {
                            if (lbl.tagName && lbl.tagName.toLowerCase() === 'label' && lbl.querySelector) {
                                if (!lbl.querySelector('input[type="file"]')) {
                                    lbl.addEventListener('click', function (e) {
                                        try { input.click(); } catch (err) { }
                                    });
                                }
                            }
                        } catch (e) { }
                    })(fileLabels[i]);
                }
            }
        });
    </script>
</head>

<body>
    <div class="wrap">
        <div class="card">
            <h2>✂️ {{index .I18n "HeaderUpload"}}</h2>
            <form action="/upload" method="post" enctype="multipart/form-data">
                <div class="file-row">
                    <label class="fileBtn">{{index .I18n "ChooseVideo"}}
                        <input id="videosInput" class="visually-hidden" type="file" name="videos" accept="video/*"
                            multiple>
                    </label>
                    <div>
                        <select id="langSelect" onchange="setLangAndReload(this.value)">
                            {{range .AvailableLocales}}
                            <option value="{{.Code}}" {{if .Selected}}selected{{end}}>{{.Name}}</option>
                            {{end}}
                        </select>
                    </div>
                </div>

                <div class="cut-row">
                    <div class="cut-head cut-col">
                        <label class="field-label">{{index .I18n "HeadLabel"}}</label>
                        <input class="input-box" type="number" name="head" min="0" value="{{.Head}}">
                    </div>
                    <div class="cut-tail cut-col">
                        <label class="field-label">{{index .I18n "TailLabel"}}</label>
                        <input class="input-box" type="number" name="tail" min="0"
                            value="{{if .Tail}}{{.Tail}}{{else}}0{{end}}">
                    </div>
                </div>
                <div class="filename" id="fileList"></div>
                <button type="submit" id="uploadBtn">{{index .I18n "UploadButton"}}</button>
                <div class="hint">{{index .I18n "Hint"}}</div>
            </form>
            <form id="clearForm" method="post" action="/clear" class="mt-10">
                <button type="submit" class="fileBtn danger">{{index .I18n "ClearButton"}}</button>
            </form>
        </div>
    </div>
    <script>
        (function () {
            var f = document.getElementById('clearForm');
            if (f) {
                f.addEventListener('submit', function (e) {
                    if (!confirm('{{index .I18n "ConfirmClear"}}')) e.preventDefault();
                });
            }
        })();
        function setLangAndReload(code) {
            try {
                var maxAge = 30 * 24 * 3600; // 30 days
                document.cookie = 'lang=' + encodeURIComponent(code) + ';path=/;max-age=' + maxAge;
            } catch (e) { }
            // navigate to set server-side cookie as well
            location.search = '?lang=' + encodeURIComponent(code);
        }
    </script>
</body>

</html>