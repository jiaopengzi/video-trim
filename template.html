{{define "common-styles"}}
<style>
    :root {
        --bg: #f7f8fa;
        --card: #ffffff;
        --accent: #007bff;
        --accent-green: #10b981;
        --danger: #ef4444;
        --muted: #6b7280;
        --text: #0f172a;
        --border: #e5e7eb;
        --shadow: rgba(2, 6, 23, 0.06)
    }

    html,
    body {
        height: 100%
    }

    body {
        margin: 0;
        font-family: "roboto", "Microsoft YaHei", Helvetica, Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
        padding: 12px 18px
    }

    .wrap {
        max-width: 720px;
        margin: 0 auto
    }

    .card {
        background: var(--card);
        padding: 14px;
        border-radius: 12px;
        box-shadow: 0 6px 18px var(--shadow)
    }

    h2 {
        font-size: 18px;
        margin: 0 0 12px
    }

    button {
        appearance: none;
        border: 0;
        background: var(--accent);
        color: white;
        padding: 12px;
        border-radius: 10px;
        font-size: 16px;
        cursor: pointer
    }

    .btn {
        display: inline-block;
        background: #0366d6;
        color: #fff;
        padding: 8px 12px;
        border-radius: 10px;
        text-decoration: none;
        font-size: 14px;
        border: 0
    }

    .muted {
        color: var(--muted);
        font-size: 13px
    }

    .mt-10 {
        margin-top: 10px
    }

    .visually-hidden {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0 0 0 0);
        white-space: nowrap;
        border: 0;
        left: -9999px
    }
</style>
{{end}}

<!DOCTYPE html>
<html lang="{{.Lang}}">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>{{index .I18n "Title"}}</title>
    {{template "common-styles"}}
    <style>
        /* 上传页面专用样式 */
        form {
            display: flex;
            flex-direction: column;
            gap: 12px
        }

        .file-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 16px 0
        }

        .fileBtn {
            display: inline-block;
            padding: 12px 14px;
            background: var(--accent);
            color: #fff;
            border-radius: 10px;
            font-weight: 600
        }

        .danger {
            background: var(--danger)
        }

        input[type=file] {
            flex: 1
        }

        .filename {
            font-size: 13px;
            color: var(--muted);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap
        }

        #fileList {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px
        }

        .file-item {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            background: #f8fafc;
            padding: 8px 10px;
            border-radius: 8px;
            font-size: 13px
        }

        .file-top {
            display: flex;
            align-items: center;
            gap: 8px
        }

        .file-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 8px
        }

        .file-size {
            color: var(--muted);
            font-size: 12px;
            margin-left: 8px
        }

        .file-remove-btn {
            background: var(--danger);
            color: #fff;
            padding: 6px 8px;
            border-radius: 8px;
            border: 0;
            font-size: 12px;
            cursor: pointer;
            margin-left: 8px
        }

        .progress-container {
            width: 100%;
            height: 8px;
            background: #e6eef8;
            border-radius: 8px;
            margin-top: 8px;
            overflow: hidden
        }

        .progress-bar {
            height: 100%;
            background: #0366d6;
            width: 0%;
            transition: width .2s linear
        }

        .hint {
            font-size: 13px;
            color: var(--muted);
            margin-top: 8px
        }

        .cut-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: stretch
        }

        #langSelect {
            width: 100%;
            box-sizing: border-box;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: #ffffff;
            font-size: 16px;
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer
        }

        .cut-col {
            flex: 1;
            min-width: 160px;
            margin-top: 10px
        }

        .field-label {
            font-size: 13px;
            color: #374151;
            display: block;
            margin-bottom: 4px
        }

        .input-box {
            width: calc(100% - 8px);
            padding: 8px;
            border-radius: 8px;
            border: 1px solid var(--border);
            box-sizing: border-box;
            margin-right: 8px
        }
    </style>
    <script>
        // 最大上传文件大小(字节)
        var MAX_UPLOAD_BYTES = parseInt('{{.MaxUpload}}', 10) || null;

        // 最大上传大小(可读格式, 如 "100MB")
        var MAX_UPLOAD_READABLE = '{{.MaxUploadReadable}}';

        // 国际化文本
        var I18N = {
            SelectAtLeastOne: '{{index .I18n "SelectAtLeastOne"}}',
            FileTooLargePrefix: '{{index .I18n "FileTooLargePrefix"}}',
            FileTooLargeSuffix: '{{index .I18n "FileTooLargeSuffix"}}',
            FileTooLargeEnd: '{{index .I18n "FileTooLargeEnd"}}',
            UploadingText: '{{index .I18n "UploadingText"}}',
            UploadButton: '{{index .I18n "UploadButton"}}',
            Hint: '{{index .I18n "Hint"}}',
            UploadError: '{{index .I18n "UploadError"}}',
            UploadFailed: '{{index .I18n "UploadFailed"}}',
            Remove: '{{index .I18n "Remove"}}'
        };

        window.addEventListener('DOMContentLoaded', function () {
            var input = document.getElementById('videosInput');
            var listEl = document.getElementById('fileList');
            var btn = document.querySelector('button[type="submit"]');

            // 已选择的文件列表
            var selectedFiles = [];

            // 同步文件列表到 input 元素, 确保表单提交时包含所有文件
            function updateInputFiles() {
                try {
                    var dt = new DataTransfer();
                    selectedFiles.forEach(function (f) { dt.items.add(f); });
                    input.files = dt.files;
                } catch (e) { }
            }

            // 渲染文件列表UI, 显示文件名、大小、移除按钮和进度条
            function renderList() {
                listEl.innerHTML = '';
                selectedFiles.forEach(function (f, idx) {
                    // 创建文件项容器
                    var it = document.createElement('div'); it.className = 'file-item';
                    var top = document.createElement('div'); top.className = 'file-top';

                    // 文件名
                    var n = document.createElement('div'); n.className = 'file-name'; n.textContent = f.name;

                    // 文件大小
                    var s = document.createElement('div'); s.className = 'file-size'; s.textContent = (f.size ? Math.round(f.size / 1024) + ' KB' : '');

                    // 移除按钮
                    var rem = document.createElement('button'); rem.className = 'file-remove-btn'; rem.textContent = I18N.Remove;
                    rem.addEventListener('click', function (e) {
                        e.preventDefault();

                        // 从列表中移除该文件
                        selectedFiles.splice(idx, 1);
                        updateInputFiles();
                        renderList();
                    });
                    top.appendChild(n); top.appendChild(s); top.appendChild(rem);

                    // 上传进度条
                    var progressWrap = document.createElement('div'); progressWrap.className = 'progress-container';
                    var progressBar = document.createElement('div'); progressBar.className = 'progress-bar';
                    progressBar.setAttribute('data-idx', idx);
                    progressWrap.appendChild(progressBar);
                    it.appendChild(top);
                    it.appendChild(progressWrap);
                    listEl.appendChild(it);
                });
            }

            // 监听文件选择变化, 将新选择的文件添加到列表
            input.addEventListener('change', function () {
                var files = Array.from(this.files || []);
                selectedFiles = selectedFiles.concat(files);
                updateInputFiles();
                renderList();
            });

            var uploadForm = document.querySelector('form[action="/upload"]');

            // 防止重复提交的标志
            var isSubmitting = false;
            if (uploadForm) {
                uploadForm.addEventListener('submit', function (e) {
                    e.preventDefault();

                    var submitBtn = this.querySelector('button[type="submit"]');

                    // 防止重复提交
                    if (isSubmitting) {
                        return;
                    }

                    // 检查是否选择了文件
                    if (!(selectedFiles && selectedFiles.length > 0)) {
                        alert(I18N.SelectAtLeastOne);
                        return;
                    }

                    // 检查每个文件大小是否超过限制
                    for (var xi = 0; xi < selectedFiles.length; xi++) {
                        var sf = selectedFiles[xi];
                        if (typeof MAX_UPLOAD_BYTES === 'number' && (sf.size || 0) > MAX_UPLOAD_BYTES) {
                            alert(I18N.FileTooLargePrefix + sf.name + I18N.FileTooLargeSuffix + MAX_UPLOAD_READABLE + I18N.FileTooLargeEnd);
                            if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = I18N.UploadButton; submitBtn.removeAttribute('aria-busy'); }
                            isSubmitting = false;
                            return;
                        }
                    }

                    isSubmitting = true;

                    // 禁用提交按钮并显示上传中状态
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.textContent = I18N.UploadingText;
                        submitBtn.setAttribute('aria-busy', 'true');
                    }

                    // 禁用所有的移除按钮, 防止在上传过程中修改文件列表
                    var removeBtns = Array.from(this.querySelectorAll('.file-remove-btn'));
                    removeBtns.forEach(function (b) { try { b.disabled = true; } catch (e) { } });

                    // 构建 FormData 对象
                    var formData = new FormData();
                    for (var i = 0; i < selectedFiles.length; i++) {
                        formData.append('videos', selectedFiles[i], selectedFiles[i].name);
                    }

                    // 添加片头片尾裁剪参数
                    var headInput = this.querySelector('input[name="head"]');
                    if (headInput) formData.append('head', headInput.value);
                    var tailInput = this.querySelector('input[name="tail"]');
                    if (tailInput) formData.append('tail', tailInput.value);

                    var xhr = new XMLHttpRequest();
                    var totalSizes = selectedFiles.reduce(function (acc, f) { return acc + (f.size || 0); }, 0);

                    // 监听上传进度, 更新每个文件的进度条
                    xhr.upload.onprogress = function (ev) {
                        var loaded = ev.loaded;
                        var acc = 0;
                        for (var i = 0; i < selectedFiles.length; i++) {
                            var f = selectedFiles[i];
                            var prev = acc;
                            acc += f.size || 0;

                            // 计算当前文件已上传的字节数
                            var fileLoaded = Math.max(0, Math.min(f.size || 0, loaded - prev));
                            var pct = f.size ? Math.round((fileLoaded / f.size) * 100) : 0;
                            var bar = document.querySelector('.progress-bar[data-idx="' + i + '"]');
                            if (bar) bar.style.width = pct + '%';
                        }
                    };

                    // 上传完成回调
                    xhr.onload = function () {
                        if (xhr.status >= 200 && xhr.status < 400) {
                            // 成功：用服务器返回的HTML替换当前页面
                            document.open();
                            document.write(xhr.responseText);
                            document.close();
                        } else {
                            // 失败：显示错误信息
                            var resp = xhr.responseText && xhr.responseText.trim() ? xhr.responseText : (I18N.UploadFailed + xhr.statusText);
                            try {
                                if (resp.indexOf('<') === 0) {
                                    document.open();
                                    document.write(resp);
                                    document.close();
                                } else {
                                    alert(resp);
                                }
                            } catch (e) {
                                alert(resp);
                            }

                            // 恢复提交按钮
                            if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = I18N.UploadButton; submitBtn.removeAttribute('aria-busy'); }

                            // 恢复移除按钮
                            removeBtns.forEach(function (b) { try { b.disabled = false; } catch (e) { } });
                            isSubmitting = false;
                        }
                    };

                    // 网络错误回调
                    xhr.onerror = function () {
                        alert(I18N.UploadError);
                        if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = I18N.UploadButton; submitBtn.removeAttribute('aria-busy'); }

                        // 恢复移除按钮
                        removeBtns.forEach(function (b) { try { b.disabled = false; } catch (e) { } });
                        isSubmitting = false;
                    };

                    // 发送请求
                    xhr.open('POST', uploadForm.action);
                    xhr.send(formData);
                });
            }

            // 为文件选择按钮添加点击事件(兼容性处理)
            var fileLabels = document.getElementsByClassName('fileBtn');
            if (fileLabels && fileLabels.length && input) {
                for (var i = 0; i < fileLabels.length; i++) {
                    (function (lbl) {
                        try {
                            if (lbl.tagName && lbl.tagName.toLowerCase() === 'label' && lbl.querySelector) {
                                if (!lbl.querySelector('input[type="file"]')) {
                                    lbl.addEventListener('click', function (e) {
                                        try { input.click(); } catch (err) { }
                                    });
                                }
                            }
                        } catch (e) { }
                    })(fileLabels[i]);
                }
            }
        });
    </script>
</head>

<body>
    <div class="wrap">
        <div class="card">
            <h2>✂️ {{index .I18n "HeaderUpload"}}</h2>
            <form action="/upload" method="post" enctype="multipart/form-data">
                <div class="file-row">
                    <label class="fileBtn">{{index .I18n "ChooseVideo"}}
                        <input id="videosInput" class="visually-hidden" type="file" name="videos" accept="video/*"
                            multiple>
                    </label>
                    <div>
                        <select id="langSelect" onchange="setLangAndReload(this.value)">
                            {{range .AvailableLocales}}
                            <option value="{{.Code}}" {{if .Selected}}selected{{end}}>{{.Name}}</option>
                            {{end}}
                        </select>
                    </div>
                </div>

                <div class="cut-row">
                    <div class="cut-head cut-col">
                        <label class="field-label">{{index .I18n "HeadLabel"}}</label>
                        <input class="input-box" type="number" name="head" min="0" value="{{.Head}}">
                    </div>
                    <div class="cut-tail cut-col">
                        <label class="field-label">{{index .I18n "TailLabel"}}</label>
                        <input class="input-box" type="number" name="tail" min="0"
                            value="{{if .Tail}}{{.Tail}}{{else}}0{{end}}">
                    </div>
                </div>
                <div class="filename" id="fileList"></div>
                <button type="submit" id="uploadBtn">{{index .I18n "UploadButton"}}</button>
                <div class="hint">{{index .I18n "Hint"}}</div>
            </form>
            <form id="clearForm" method="post" action="/clear" class="mt-10">
                <button type="submit" class="fileBtn danger">{{index .I18n "ClearButton"}}</button>
            </form>
        </div>
    </div>
    <script>
        // 清除表单提交前的确认对话框
        (function () {
            var f = document.getElementById('clearForm');
            if (f) {
                f.addEventListener('submit', function (e) {
                    // 用户取消则阻止表单提交
                    if (!confirm('{{index .I18n "ConfirmClear"}}')) e.preventDefault();
                });
            }
        })();

        // 切换语言并刷新页面
        function setLangAndReload(code) {
            try {
                // 设置 cookie, 有效期30天
                var maxAge = 30 * 24 * 3600;
                document.cookie = 'lang=' + encodeURIComponent(code) + ';path=/;max-age=' + maxAge;
            } catch (e) { }
            // 通过 URL 参数通知服务器切换语言
            location.search = '?lang=' + encodeURIComponent(code);
        }
    </script>
</body>

</html>

{{define "result"}}
<!DOCTYPE html>
<html lang="{{.Lang}}">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>{{.Title}}</title>
    {{template "common-styles"}}
    <style>
        .downloadAllBtn {
            display: block;
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            background: var(--accent-green);
            color: #fff;
            border: 0;
            font-size: 16px;
            margin-bottom: 12px
        }

        .list {
            display: flex;
            flex-direction: column;
            gap: 10px
        }

        .item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #fff;
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 6px 18px var(--shadow)
        }

        .name {
            flex: 1;
            font-size: 14px;
            color: var(--text);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 10px
        }

        .actions {
            display: flex;
            gap: 8px
        }

        .item.requested .btn {
            background: var(--muted)
        }

        .status {
            display: none
        }

        .returnBtn {
            display: inline-block;
            margin-top: 10px;
            padding: 10px 14px;
            border-radius: 10px;
            background: #0366d6;
            color: #fff;
            text-decoration: none;
            font-weight: 600
        }
    </style>
</head>

<body>
    <div class="wrap">
        <h2>{{.Title}}</h2>
        <button id="downloadAll" class="downloadAllBtn">{{.DownloadAll}}</button>
        <div class="list">
            {{range $idx, $file := .Files}}
            <div class="item">
                <div class="name">{{$file.Name}}</div>
                <div class="actions">
                    <a class="btn" href="{{$file.Link}}" download
                        onclick="markRequested('status-{{$idx}}')">{{$.DownloadText}}</a>
                </div>
                <div class="status" id="status-{{$idx}}"></div>
            </div>
            {{end}}
        </div>
        {{if not .Files}}
        <p class="muted">{{.NoFilesHint}}</p>
        {{end}}
        <p><a class="returnBtn" href="/">{{.ReturnUpload}}</a></p>
    </div>
    <script>
        // 从服务器获取的文件列表(JSON格式)
        var files = JSON.parse('{{ safeJS .FilesJSON }}');

        // 一键下载所有文件
        (function () {
            document.getElementById('downloadAll').addEventListener('click', async function () {
                if (!files || !files.length) return;
                // 禁用按钮防止重复点击
                this.disabled = true;

                // 逐个下载文件
                for (let i = 0; i < files.length; i++) {
                    try {
                        // 标记该文件已请求下载
                        markRequested('status-' + i);
                    } catch (e) { }
                    let f = files[i];
                    try {
                        // 获取文件内容
                        let resp = await fetch('/download/' + encodeURIComponent(f));
                        if (!resp.ok) {
                            console.error('fetch failed', f);
                            continue;
                        }

                        // 转换为 Blob 并触发下载
                        let blob = await resp.blob();
                        let url = URL.createObjectURL(blob);
                        let a = document.createElement('a');
                        a.href = url;
                        a.download = f;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();

                        // 释放 URL 对象
                        URL.revokeObjectURL(url);
                    } catch (e) {
                        console.error(e);
                    }

                    // 延迟500ms再下载下一个, 避免浏览器限制
                    await new Promise(r => setTimeout(r, 500));
                }

                // 恢复按钮
                this.disabled = false;
            });
        })();

        // 标记文件项为"已请求下载"状态(改变样式)
        function markRequested(id) {
            try {
                var el = document.getElementById(id);
                if (!el) return;
                var p = el.closest('.item');
                if (p) p.classList.add('requested');
            } catch (e) {
                console.error(e);
            }
        }
    </script>
</body>

</html>
{{end}}